<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Point of Sale</title>
    <meta name="theme-color" content="#b5651d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Hive POS">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/sweetplace logo.png">
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background: #f8f8f8; }
        h1 { color: #b5651d; }
        #categoryTabs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .menu-list { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        .menu-item { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #eee; padding: 1rem; width: 160px; min-width: 120px; cursor: pointer; transition: box-shadow 0.2s; display: flex; flex-direction: column; align-items: center; }
        .menu-item:hover { box-shadow: 0 4px 16px #ccc; }
        .menu-item img { width: 100%; height: 90px; object-fit: cover; border-radius: 4px; }
        .menu-item h3 { font-size: 1.1em; margin: 0.5em 0 0.2em 0; text-align: center; }
        .menu-item p { font-size: 1em; margin: 0; text-align: center; }
        .cart { margin-top: 2rem; background: hsl(0, 0%, 100%); border-radius: 8px; box-shadow: 0 2px 8px #eee; padding: 1rem; max-width: 100%; width: 100%; box-sizing: border-box; }
        .cart h2 { margin-top: 0; font-size: 1.2em; }
        .cart-list { list-style: none; padding: 0; margin: 0; }
        .cart-list li { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee; font-size: 1em; }
        .cart-list button { font-size: 1.1em; padding: 0.3em 0.7em; margin: 0 2px; border-radius: 4px; border: none; background: #eee; color: #333; cursor: pointer; }
        .cart-list button:active { background: #b5651d; color: #fff; }
        .cart-list .remove-btn { background: #e74c3c; color: #fff; }
        .cart-total { font-size: 1.2em; font-weight: bold; text-align: right; margin-top: 1rem; }
        .pay-btn { width: 100%; background: #27ae60; color: #fff; border: none; padding: 1rem; border-radius: 4px; font-size: 1.2em; margin-top: 1rem; cursor: pointer; }
        @media (max-width: 600px) {
            body { margin: 0.5rem; }
            .menu-list { gap: 0.5rem; }
            .menu-item { width: 45vw; min-width: 100px; padding: 0.5rem; }
            .menu-item img { height: 60px; }
            .cart { padding: 0.5rem; }
            .cart-list li { font-size: 0.95em; }
            .pay-btn { padding: 0.7rem; font-size: 1em; }
        }
    </style>
</head>
<body>
    <div id="configSourceBar" style="position:absolute;top:1rem;left:1.5rem;background:#fff7e6;border-radius:6px;padding:0.5em 1em;box-shadow:0 2px 8px #eee;z-index:10;display:flex;align-items:center;gap:1em;min-width:180px;font-size:0.98em;">
        <span id="configSourceText">Source: Local Storage</span>
        <button id="updateStoreBtn" style="background:#b5651d;color:#fff;border:none;border-radius:4px;padding:0.3em 0.8em;cursor:pointer;font-size:1em;">Update Store</button>
        <input type="file" id="storeFileInput" accept="application/json" style="display:none;" />
    </div>
    <div id="bannerContainer" style="text-align:center;margin-bottom:1rem;"></div>
    <h1 id="businessNameHeader">Point of Sale</h1>
    <div id="categoryTabs"></div>
    <div class="menu-list" id="menuList"></div>
    <div class="cart" id="cart">
        <h2 style="display:inline-flex;align-items:center;gap:0.5em;">Cart
            <button id="clearCartBtn" title="Clear Cart" style="background:#e74c3c;color:#fff;border:none;border-radius:50%;width:2em;height:2em;display:inline-flex;align-items:center;justify-content:center;font-size:1.2em;margin-left:0.5em;cursor:pointer;vertical-align:middle;">
                üóëÔ∏è
            </button>
        </h2>
        <ul class="cart-list" id="cartList"></ul>
        <div class="cart-total" id="cartTotal">Total: $0.00</div>
    </div>
    <div id="hiveAccountDisplay" style="position:absolute;top:1.5rem;right:2rem;font-size:1.1em;color:#333;background:#fff2;border-radius:6px;padding:0.4em 1em;box-shadow:0 2px 8px #eee;"></div>
    <div id="qrInlineContainer" style="display:none;justify-content:center;margin-top:1.5rem;"></div>
    <!-- Add QR code library if not already present -->
    <script>
    if (!window.QRCode) {
        var script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
        document.head.appendChild(script);
    }
    </script>
    <script>
        // --- Bitcoin Lightning minimum amount check ---
        function isLightningAmountValid(amount, currency) {
            // Accept both 'USD' and 'usd' for safety
            return !(currency === 'USD' || currency === 'usd') || parseFloat(amount) >= 0.25;
        }
        // Load items from localStorage
        function getItems() {
            return JSON.parse(localStorage.getItem('pos_items') || '[]');
        }
        // --- Banner and Business Name Logic ---
        function getStoreSettings() {
            return JSON.parse(localStorage.getItem('pos_settings') || '{"businessName":"","bannerUrl":"","categories":["drink","pastry","bread","other"],"hiveAccount":""}');
        }
        function renderBannerAndName() {
            const settings = getStoreSettings();
            // Banner
            const bannerDiv = document.getElementById('bannerContainer');
            bannerDiv.innerHTML = settings.bannerUrl ? `<img src="${settings.bannerUrl}" alt="Banner" style="max-width:100%;max-height:120px;border-radius:8px;">` : '';
            // Business Name
            document.getElementById('businessNameHeader').textContent = settings.businessName || 'Point of Sale';
        }
        // --- Category Tabs Logic (updated to use store settings) ---
        function getCategories(items) {
            const settings = getStoreSettings();
            // Only show categories that exist in store settings
            return (settings.categories || []).filter(cat => items.some(item => item.category === cat));
        }
        let currentCategory = 'all';
        function renderCategoryTabs(items) {
            const cats = getCategories(items);
            const tabs = document.getElementById('categoryTabs');
            tabs.innerHTML = '';
            // All button
            const allBtn = document.createElement('button');
            allBtn.textContent = 'All';
            allBtn.style.fontWeight = currentCategory === 'all' ? 'bold' : '';
            allBtn.onclick = () => { currentCategory = 'all'; renderMenu(); };
            tabs.appendChild(allBtn);
            // Category buttons
            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                btn.style.fontWeight = currentCategory === cat ? 'bold' : '';
                btn.onclick = () => { currentCategory = cat; renderMenu(); };
                tabs.appendChild(btn);
            });
        }
        // Render menu
        function renderMenu() {
            renderBannerAndName();
            renderHiveAccount();
            const items = getItems();
            renderCategoryTabs(items);
            const menu = document.getElementById('menuList');
            menu.innerHTML = '';
            const filtered = currentCategory === 'all' ? items : items.filter(i => i.category === currentCategory);
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `
                    <img src="${item.image}" alt="${item.name}">
                    <h3>${item.name}</h3>
                    <p><b>Price:</b> $${item.price.toFixed(2)}</p>
                `;
                div.onclick = () => addToCart(item);
                menu.appendChild(div);
            });
        }
        // Cart logic
        let cart = [];
        function addToCart(item) {
            // Check if item already in cart
            const found = cart.find(ci => ci.id === item.id);
            if (found) {
                found.qty += 1;
            } else {
                cart.push({ ...item, qty: 1 });
            }
            renderCart();
        }
        function renderCart() {
            const list = document.getElementById('cartList');
            list.innerHTML = '';
            cart.forEach((item, idx) => {
                const lineTotal = item.price * item.qty;
                list.innerHTML += `<li>
                    <span>${item.name} x${item.qty}</span>
                    <span>
                        <button onclick="changeQty(${idx}, -1)" style="margin-right:2px;">-</button>
                        <button onclick="changeQty(${idx}, 1)" style="margin-right:8px;">+</button>
                        <button onclick="removeFromCart(${idx})" style="background:#e74c3c;">üóëÔ∏è</button>
                        $${lineTotal.toFixed(2)}
                    </span>
                </li>`;
            });
            const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
            document.getElementById('cartTotal').textContent = `Total: $${total.toFixed(2)}`;
        }
        function renderHiveAccount() {
            const settings = getStoreSettings();
            const hiveDiv = document.getElementById('hiveAccountDisplay');
            if (settings.hiveAccount) {
                hiveDiv.innerHTML = `<b>Receiving Hive:</b> @${settings.hiveAccount}`;
                hiveDiv.style.display = '';
            } else {
                hiveDiv.innerHTML = '';
                hiveDiv.style.display = 'none';
            }
        }
        // QR Inline logic
        function showQrInline() {
            const settings = getStoreSettings();
            const hiveAccount = settings.hiveAccount;
            if (!hiveAccount) {
                alert('No Hive account set for receiving payments.');
                return;
            }
            const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
            if (total <= 0) {
                alert('Cart is empty.');
                return;
            }
            // Prepare memo: use current system time (ISO string)
            const memoDecoded = new Date().toISOString();
            window.lastPaymentMemo = memoDecoded; // Save for listener
            window.lastPaymentAmount = `${total.toFixed(3)} HBD`;
            const op = [
              "transfer",
              {
                to: hiveAccount,
                amount: `${total.toFixed(3)} HBD`,
                memo: memoDecoded
              }
            ];
            const json = JSON.stringify(op);
            const base64 = btoa(json)
              .replace(/\+/g, "-")
              .replace(/\//g, "_")
              .replace(/=+$/, "");
            const uri = `hive://sign/op/${base64}`;

            // Generate QR code
            const qrDiv = document.getElementById('qrInlineContainer');
            qrDiv.innerHTML = `<div style='background:#fff;padding:1.5rem 1rem 1rem 1rem;border-radius:12px;box-shadow:0 4px 24px #0002;display:flex;flex-direction:column;align-items:center;justify-content:center;max-width:350px;margin:auto;'>
                <h2 style='margin-top:0;text-align:center;'>Scan to Pay with Hive Keychain</h2>
                <div id='qrCodeInline' style='margin:1rem 0;min-height:240px;'></div>
                <div style='font-size:1.1em;margin-bottom:1rem;text-align:center;'><b>To:</b> @${hiveAccount}<br><b>Amount:</b> ${total.toFixed(3)} HBD</div>
                <div style='word-break:break-all;font-size:0.95em;background:#f4f4f4;padding:0.5em 0.7em;border-radius:6px;margin-top:0.5em;text-align:center;'>${uri}</div>
                <div id='paymentStatus' style='margin-top:1em;font-size:1.1em;color:#27ae60;'></div>
            </div>`;
            qrDiv.style.display = 'flex';
            qrDiv.style.justifyContent = 'center';
            qrDiv.style.alignItems = 'center';
            setTimeout(() => {
                const qrCodeDiv = document.getElementById('qrCodeInline');
                qrCodeDiv.innerHTML = '';
                if (window.QRCode) {
                    new QRCode(qrCodeDiv, {
                        text: uri,
                        width: 240,
                        height: 240,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } else {
                    qrCodeDiv.textContent = 'QR code library not loaded.';
                }
            }, 0);
            // Start payment listener
            startPaymentListener();
        }

        // --- Payment Listener ---
        let paymentListenerInterval = null;
        function startPaymentListener() {
            if (paymentListenerInterval) clearInterval(paymentListenerInterval);
            const settings = getStoreSettings();
            const hiveAccount = settings.hiveAccount;
            const expectedAmount = window.lastPaymentAmount;
            const expectedMemo = window.lastPaymentMemo;
            const statusDiv = document.getElementById('paymentStatus');
            let attempts = 0;
            paymentListenerInterval = setInterval(async function() {
                attempts++;
                if (!hiveAccount || !expectedAmount || !expectedMemo) return;
                try {
                    const response = await fetch('https://api.hive.blog', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            method: 'condenser_api.get_account_history',
                            params: [hiveAccount, -1, 20],
                            id: 1
                        })
                    });
                    const data = await response.json();
                    const history = data.result;
                    for (let i = history.length - 1; i >= 0; i--) {
                        const op = history[i][1].op;
                        if (op[0] === 'transfer' &&
                            op[1].to === hiveAccount &&
                            op[1].amount === expectedAmount &&
                            op[1].memo === expectedMemo) {
                            statusDiv.textContent = '‚úÖ Payment received!';
                            clearInterval(paymentListenerInterval);
                            paymentListenerInterval = null;
                            // Show post-sale actions for HBD
                            const saleCart = cart.map(i => ({...i}));
                            const saleTotal = saleCart.reduce((sum, i) => sum + i.price * i.qty, 0);
                            cart = [];
                            renderCart();
                            renderMenu();
                            showPostSaleActions('HBD', saleCart, saleTotal);
                            return;
                        }
                    }
                    statusDiv.textContent = '‚è≥ Waiting for payment...';
                } catch (e) {
                    statusDiv.textContent = 'Error checking payment.';
                }
                if (attempts > 100) {
                    statusDiv.textContent = 'Payment not detected. Please check manually.';
                    clearInterval(paymentListenerInterval);
                    paymentListenerInterval = null;
                }
            }, 3000);
        }
        // --- Payment Buttons (side by side) ---
        const cartDiv = document.getElementById('cart');
        function isBitcoinLightningEnabled() {
            const settings = getStoreSettings();
            return !!settings.bitcoinLightningEnabled && settings.bitcoinLightningConfig;
        }
        function getCartHasItems() {
            return cart && cart.length > 0;
        }
        function renderPaymentButtons() {
            let html = `<div id="paymentButtonsRow" style="display:flex;gap:1em;margin-top:1.5em;justify-content:center;">`;
            const cartHasItems = getCartHasItems();
            html += `<button id="payWithCashBtn" type="button" style="flex:1 1 0%;background:#f5b041;color:#fff;font-size:1.2em;padding:1em 0.5em;border:none;border-radius:6px;min-width:0;" ${cartHasItems ? '' : 'disabled'}>Pay with Cash</button>`;
            html += `<button id="payWithHbdBtn" type="button" style="flex:1 1 0%;background:#27ae60;color:#fff;font-size:1.2em;padding:1em 0.5em;border:none;border-radius:6px;min-width:0;" ${cartHasItems ? '' : 'disabled'}>Pay with HBD</button>`;
            if (isBitcoinLightningEnabled()) {
                html += `<button id="payWithBtcBtn" type="button" style="flex:1 1 0%;background:#f7931a;color:#fff;font-size:1.2em;padding:1em 0.5em;border:none;border-radius:6px;min-width:0;" ${cartHasItems ? '' : 'disabled'}>Bitcoin Lightning</button>`;
            }
            html += `</div>`;
            html += `<div id="cashPaymentSection" style="display:none;margin-top:1.5em;text-align:center;">
      <div style="margin-bottom:1em;">
        <label for="cashGivenInput"><b>Cash Given:</b></label>
        <input id="cashGivenInput" type="number" min="0" step="0.01" style="width:100px;font-size:1.1em;margin-left:0.5em;" />
      </div>
      <div id="changeDueDisplay" style="font-size:1.2em;margin-bottom:1em;"></div>
      <button id="finishCashSaleBtn" style="background:#27ae60;color:#fff;font-size:1.2em;padding:0.7em 2em;border:none;border-radius:6px;position:relative;right:0;">Finish Sale</button>
    </div>`;
            // Replace or insert payment buttons
            let oldRow = document.getElementById('paymentButtonsRow');
            if (oldRow) oldRow.parentNode.removeChild(oldRow);
            cartDiv.insertAdjacentHTML('afterend', html);
        }
        function setupPaymentButtons() {
            renderPaymentButtons();
            const payWithCashBtn = document.getElementById('payWithCashBtn');
            const payWithHbdBtn = document.getElementById('payWithHbdBtn');
            const payWithBtcBtn = document.getElementById('payWithBtcBtn');
            const qrInline = document.getElementById('qrInlineContainer');
            const cashSection = document.getElementById('cashPaymentSection');
            const cashInput = document.getElementById('cashGivenInput');
            const changeDue = document.getElementById('changeDueDisplay');
            const finishBtn = document.getElementById('finishCashSaleBtn');
            function getTotal() {
                return cart.reduce(function(sum, item) { return sum + item.price * item.qty; }, 0);
            }
            function showKeychain() {
                qrInline.style.display = 'flex';
                cashSection.style.display = 'none';
            }
            function showCash() {
                qrInline.style.display = 'none';
                cashSection.style.display = 'block';
                cashInput.value = '';
                changeDue.textContent = '';
            }
            if (payWithCashBtn) payWithCashBtn.onclick = showCash;
            if (payWithHbdBtn) payWithHbdBtn.onclick = function() {
                showKeychain();
                showQrInline();
            };
            if (payWithBtcBtn) payWithBtcBtn.onclick = async function() {
                // Get config
                const settings = getStoreSettings();
                const bl = settings.bitcoinLightningConfig;
                if (!bl) {
                    alert('Bitcoin Lightning config missing.');
                    return;
                }
                // Calculate total in USD (or use POS currency logic if needed)
                const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
                if (!total || total <= 0) {
                    alert('Cart is empty.');
                    return;
                }
                const currency = bl.currency || 'USD';
                if (!isLightningAmountValid(total, currency)) {
                    alert('Minimum amount for Bitcoin Lightning is $0.25 USD.');
                    return;
                }
                // --- Generate short memo BEFORE invoice creation ---
                const shortMemo = `HivePOS-${Math.floor(Math.random()*9000+1000)}`; // 4 random digits for uniqueness
                window.lastLightningMemo = shortMemo;
                // Show modal and loading state
                const modal = document.getElementById('btcLightningQrModal');
                modal.style.display = 'flex';
                document.getElementById('btcLightningQrAccount').textContent = 'Receiving: @' + (bl.hive_accname || '');
                document.getElementById('btcLightningInvoice').textContent = 'Requesting invoice...';
                const qrDiv = document.getElementById('btcLightningQrCode');
                qrDiv.innerHTML = '';
                // Build API call WITH message (memo) set
                const params = new URLSearchParams({
                    hive_accname: bl.hive_accname,
                    amount: total.toFixed(2),
                    currency: bl.currency,
                    receive_currency: bl.receive_currency,
                    usd_hbd: 'false',
                    app_name: bl.app_name,
                    expiry: bl.expiry,
                    message: shortMemo,
                    qr_code: bl.qr_code
                });
                const url = `https://api.v4v.app/v1/new_invoice_hive?${params.toString()}`;
                try {
                    const res = await fetch(url, { headers: { 'accept': 'application/json' } });
                    if (!res.ok) throw new Error('API error: ' + res.status);
                    const data = await res.json();
                    if (data.payment_request) {
                        document.getElementById('btcLightningInvoice').textContent = data.payment_request;
                        qrDiv.innerHTML = '';
                        if (window.QRCode) {
                            new QRCode(qrDiv, {
                                text: data.payment_request,
                                width: 220,
                                height: 220,
                                colorDark: '#000',
                                colorLight: '#fff',
                                correctLevel: window.QRCode.CorrectLevel.H
                            });
                        } else {
                            qrDiv.textContent = 'QR code library not loaded.';
                        }
                        // Start Lightning payment listener using the short memo
                        startLightningPaymentListener(shortMemo);
                    } else {
                        document.getElementById('btcLightningInvoice').textContent = 'No invoice received.';
                        qrDiv.innerHTML = '';
                    }
                } catch (err) {
                    document.getElementById('btcLightningInvoice').textContent = 'Error: ' + err.message;
                    qrDiv.innerHTML = '';
                }
            };
            if (cashInput) {
                cashInput.oninput = function() {
                    var given = parseFloat(cashInput.value);
                    var total = getTotal();
                    if (isNaN(given)) { changeDue.textContent = ''; return; }
                    var change = given - total;
                    changeDue.textContent = (change >= 0) ? ('Change Due: $' + change.toFixed(2)) : 'Not enough cash given.';
                };
            }
            if (finishBtn) {
                finishBtn.onclick = function() {
                    const saleCart = cart.map(i => ({...i}));
                    const saleTotal = saleCart.reduce((sum, i) => sum + i.price * i.qty, 0);
                    cart = [];
                    renderCart();
                    renderMenu();
                    showPostSaleActions('cash', saleCart, saleTotal);
                };
            }
            // Default to Keychain tab
            showKeychain();
        }
        // --- Initial Render ---
        renderMenu();
        renderCart();
        renderHiveAccount();
        setupPaymentButtons(); // Ensure payment buttons are rendered on initial load
        // Attach to pay button
        const payBtn = document.querySelector('.pay-btn');
        if (payBtn) payBtn.onclick = showQrInline;
        // Remove old payment mode tabs if present
        var oldTabs = document.getElementById('paymentModeTabs');
        if (oldTabs) oldTabs.remove();
        var oldCashSection = document.querySelectorAll('#cashPaymentSection');
        if (oldCashSection.length > 1) {
          for (var i = 1; i < oldCashSection.length; i++) {
            oldCashSection[i].remove();
          }
        }
        // Call setupPaymentButtons after renderMenu and renderCart
        const originalRenderMenu = renderMenu;
        renderMenu = function() {
            originalRenderMenu();
            setupPaymentButtons();
        };
        const originalRenderCart = renderCart;
        renderCart = function() {
            originalRenderCart();
            setupPaymentButtons();
        };
        // --- Config Source Bar Logic ---
        function setConfigSourceText(text) {
            document.getElementById('configSourceText').textContent = 'Source: ' + text;
        }
        function getConfigSource() {
            return localStorage.getItem('pos_config_source') || 'Local Storage';
        }
        setConfigSourceText(getConfigSource());
        document.getElementById('updateStoreBtn').onclick = function() {
            document.getElementById('storeFileInput').value = '';
            document.getElementById('storeFileInput').click();
        };
        document.getElementById('storeFileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const data = JSON.parse(ev.target.result);
                    // Accept both admin backup format ({items, settings}) and legacy ({pos_items, pos_settings})
                    let items = null, settings = null;
                    if (Array.isArray(data.items) && typeof data.settings === 'object') {
                        items = data.items;
                        settings = data.settings;
                    } else if (Array.isArray(data.pos_items) && typeof data.pos_settings === 'object') {
                        items = data.pos_items;
                        settings = data.pos_settings;
                    } else {
                        throw new Error('Invalid config format.');
                    }
                    localStorage.setItem('pos_items', JSON.stringify(items));
                    localStorage.setItem('pos_settings', JSON.stringify(settings));
                    localStorage.setItem('pos_config_source', file.name);
                    setConfigSourceText(file.name);
                    // Optionally, clear cart
                    cart = [];
                    renderCart();
                    renderMenu();
                    renderHiveAccount();
                    alert('Store configuration loaded!');
                } catch (err) {
                    alert('Failed to load config: ' + err.message);
                }
            };
            reader.readAsText(file);
        };
        function changeQty(idx, delta) {
            if (cart[idx]) {
                cart[idx].qty += delta;
                if (cart[idx].qty <= 0) {
                    cart.splice(idx, 1);
                }
                renderCart();
            }
        }
        function removeFromCart(idx) {
            cart.splice(idx, 1);
            renderCart();
        }
        // Expose cart functions to global scope for inline button handlers
        window.changeQty = changeQty;
        window.removeFromCart = removeFromCart;
        // Attach clear cart button logic
        const clearCartBtn = document.getElementById('clearCartBtn');
        if (clearCartBtn) {
            clearCartBtn.onclick = function() {
                if (cart.length === 0) return;
                if (confirm('Clear all items from the cart?')) {
                    cart = [];
                    renderCart();
                    // Also hide QR/cash sections if visible
                    document.getElementById('qrInlineContainer').style.display = 'none';
                    var cashSection = document.getElementById('cashPaymentSection');
                    if (cashSection) cashSection.style.display = 'none';
                }
            };
        }
        // --- Post-Sale Actions ---
        function showPostSaleActions(paymentType, saleCart, saleTotal) {
            // Hide payment/cash/QR sections
            document.getElementById('qrInlineContainer').style.display = 'none';
            var cashSection = document.getElementById('cashPaymentSection');
            if (cashSection) cashSection.style.display = 'none';
            // Hide payment buttons
            var paymentButtonsRow = document.getElementById('paymentButtonsRow');
            if (paymentButtonsRow) paymentButtonsRow.style.display = 'none';
            // Remove previous post-sale actions if any
            let prev = document.getElementById('postSaleActionsRow');
            if (prev) prev.remove();
            // Create buttons
            const row = document.createElement('div');
            row.id = 'postSaleActionsRow';
            row.style = 'display:flex;gap:1em;margin-top:2em;justify-content:center;';
            // Save Receipt button
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save Receipt';
            saveBtn.style = 'flex:1 1 0%;background:#2980b9;color:#fff;font-size:1.1em;padding:1em 0.5em;border:none;border-radius:6px;min-width:0;';
            saveBtn.onclick = function() {
                const now = new Date();
                const pad = n => n.toString().padStart(2, '0');
                const filename = `receipt-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.json`;
                const receipt = {
                    timestamp: now.toISOString(),
                    paymentType,
                    items: saleCart.map(i => ({ id: i.id, name: i.name, qty: i.qty, price: i.price })),
                    total: saleTotal
                };
                const blob = new Blob([JSON.stringify(receipt, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
            };
            // New Sale button
            const newBtn = document.createElement('button');
            newBtn.textContent = 'New Sale';
            newBtn.style = 'flex:1 1 0%;background:#27ae60;color:#fff;font-size:1.1em;padding:1em 0.5em;border:none;border-radius:6px;min-width:0;';
            newBtn.onclick = function() {
                cart = [];
                renderCart();
                renderMenu();
                row.remove();
                // Show payment buttons again and reset their style
                var paymentButtonsRow = document.getElementById('paymentButtonsRow');
                if (paymentButtonsRow) {
                    paymentButtonsRow.style.display = 'flex';
                    paymentButtonsRow.style.gap = '1em';
                    paymentButtonsRow.style.marginTop = '1.5em';
                    paymentButtonsRow.style.justifyContent = 'center';
                }
            };
            row.appendChild(saveBtn);
            row.appendChild(newBtn);
            // Insert after cart
            const cartDiv = document.getElementById('cart');
            cartDiv.parentNode.insertBefore(row, cartDiv.nextSibling);
        }

        // Add ability to X out of the Lightning QR modal
        function showLightningQrModal(invoice) {
            // ...existing code to build modal...
            // Add close (X) button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.setAttribute('aria-label', 'Close');
            closeBtn.style.position = 'absolute';
            closeBtn.style.right = '16px';
            closeBtn.style.top = '16px';
            closeBtn.style.background = '#fff';
            closeBtn.style.color = '#f7931a';
            closeBtn.style.border = 'none';
            closeBtn.style.fontSize = '2em';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.zIndex = '10';
            closeBtn.onclick = function() {
                lightningQrModal.style.display = 'none';
            };
            lightningQrModal.style.position = 'relative';
            lightningQrModal.appendChild(closeBtn);
            // ...existing code to show QR and invoice string...
        }

        // Optionally, allow closing modal with ESC or clicking outside
        (function enhanceLightningModalClose() {
            // ...get lightningQrModal...
            document.addEventListener('keydown', function(e) {
                if (lightningQrModal.style.display === 'block' && (e.key === 'Escape' || e.key === 'Esc')) {
                    lightningQrModal.style.display = 'none';
                }
            });
            lightningQrModal.addEventListener('click', function(e) {
                if (e.target === lightningQrModal) {
                    lightningQrModal.style.display = 'none';
                }
            });
        })();
    </script>
    <!-- Bitcoin Lightning QR Modal (required for Lightning payments) -->
    <div id="btcLightningQrModal" style="display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
      <div style="background:#fff;padding:2.2em 1.5em 1.5em 1.5em;border-radius:16px;box-shadow:0 8px 32px #0003;max-width:410px;width:95vw;position:relative;display:flex;flex-direction:column;align-items:center;">
        <button id="btcLightningQrClose" style="position:absolute;top:0.7em;right:0.7em;background:none;border:none;font-size:1.6em;line-height:1;cursor:pointer;color:#e67e22;">√ó</button>
        <div id="btcLightningQrAccount" style="font-size:1.15em;margin-bottom:0.7em;text-align:center;"></div>
        <div id="btcLightningQrCode" style="margin:0 auto 1.2em auto;display:flex;justify-content:center;"></div>
        <div id="btcLightningInvoice" style="word-break:break-all;font-size:1.02em;background:#f4f4f4;padding:0.7em 0.8em;border-radius:7px;margin-bottom:0.7em;text-align:center;max-width:350px;overflow-wrap:break-word;"></div>
      </div>
    </div>
    
    <script>
    // Add Lightning QR modal close logic
    document.getElementById('closeBtcLightningQr').onclick = function() {
        document.getElementById('btcLightningQrModal').style.display = 'none';
    };
    (function enhanceLightningModalClose() {
        const modal = document.getElementById('btcLightningQrModal');
        document.addEventListener('keydown', function(e) {
            if (modal.style.display === 'flex' && (e.key === 'Escape' || e.key === 'Esc')) {
                modal.style.display = 'none';
            }
        });
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    })();
    </script>
    <!-- Bitcoin Lightning Payment Listener -->
    <script>
    let lightningPaymentListenerInterval = null;
    function startLightningPaymentListener(shortMemo) {
        if (lightningPaymentListenerInterval) clearInterval(lightningPaymentListenerInterval);
        const settings = getStoreSettings();
        const bl = settings.bitcoinLightningConfig || {};
        const hiveAccount = (bl.hive_accname || '').toLowerCase();
        const statusDiv = document.getElementById('btcLightningInvoice');
        let attempts = 0;
        lightningPaymentListenerInterval = setInterval(async function() {
            attempts++;
            if (!hiveAccount || !shortMemo) return;
            try {
                const response = await fetch('https://api.hive.blog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'condenser_api.get_account_history',
                        params: [hiveAccount, -1, 50], // fetch more ops for reliability
                        id: 1
                    })
                });
                const data = await response.json();
                const history = data.result;
                for (let i = history.length - 1; i >= 0; i--) {
                    const op = history[i][1].op;
                    if (
                        op[0] === 'transfer' &&
                        (op[1].to || '').toLowerCase() === hiveAccount &&
                        (op[1].from || '').toLowerCase() === 'v4vapp' &&
                        op[1].memo && op[1].memo.toLowerCase().includes(shortMemo.toLowerCase())
                    ) {
                        statusDiv.innerHTML = '<span style="color:#27ae60;font-weight:bold;">‚úÖ Bitcoin Lightning payment received!</span>';
                        clearInterval(lightningPaymentListenerInterval);
                        lightningPaymentListenerInterval = null;
                        showLightningPaidNotification();
                        return;
                    }
                }
                statusDiv.innerHTML = '<span style="color:#f7931a;">‚è≥ Waiting for Bitcoin Lightning payment confirmation...</span>';
            } catch (e) {
                statusDiv.innerHTML = '<span style="color:#e74c3c;">Error checking payment.</span>';
            }
            if (attempts > 100) {
                statusDiv.innerHTML = '<span style="color:#e74c3c;">Payment not detected. Please check manually.</span>';
                clearInterval(lightningPaymentListenerInterval);
                lightningPaymentListenerInterval = null;
            }
        }, 3000);
    }

    function showLightningPaidNotification() {
        // Create notification overlay
        let notif = document.createElement('div');
        notif.id = 'lightningPaidNotif';
        notif.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:2000;display:flex;align-items:center;justify-content:center;';
        notif.innerHTML = `<div style="background:#fff;padding:2.5em 2em 2em 2em;border-radius:18px;box-shadow:0 8px 32px #0003;max-width:350px;width:90vw;display:flex;flex-direction:column;align-items:center;">
            <div style='font-size:2.5em;margin-bottom:0.5em;color:#27ae60;'>‚úÖ</div>
            <div style='font-size:1.25em;font-weight:bold;text-align:center;margin-bottom:1em;'>Bitcoin Lightning Payment Confirmed!</div>
            <button id='closeLightningPaidNotif' style='background:#27ae60;color:#fff;font-size:1.1em;padding:0.7em 2em;border:none;border-radius:8px;cursor:pointer;'>OK</button>
        </div>`;
        document.body.appendChild(notif);
        document.getElementById('closeLightningPaidNotif').onclick = function() {
            notif.remove();
            // Refresh app for new sale
            window.location.reload();
        };
    }
    </script>
</body>
</html>
