<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Sales / Venta Rápida</title>
    <meta name="theme-color" content="#15202b">
    <link rel="apple-touch-icon" href="images/sweetplace logo.png">
    <link rel="stylesheet" href="https://menobass.github.io/snapnpay/styles.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: var(--background-color); color: var(--text-primary); margin: 0; padding: 0; }
        .container { max-width: 420px; margin: 2.5em auto; background: var(--card-background); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 2em 1.5em 2.5em 1.5em; border: 1px solid var(--border-color); }
        h1 { color: var(--primary-color); font-size: 2em; margin-bottom: 0.2em; text-align: center; }
        .subtitle { color: var(--text-secondary); font-size: 1em; text-align: center; margin-bottom: 2em; }
        label { font-weight: 600; color: var(--text-primary); display: block; margin-bottom: 0.3em; }
        .row { display: flex; align-items: center; gap: 0.7em; margin-bottom: 1.2em; }
        input[type=text], input[type=number] { font-size: 1.1em; }
        .form-control { width: 100%; padding: 0.75em; border: 1px solid var(--border-color); border-radius: 8px; background: var(--background-color); color: var(--text-primary); }
        .current-account { font-size: 0.98em; color: var(--text-secondary); margin-bottom: 1.2em; text-align: left; }
        .amount-input { font-size: 1.6em; text-align: center; width: 100%; margin-bottom: 1.2em; border: 1px solid var(--border-color); background: var(--background-color); color: var(--text-primary); border-radius: 8px; padding: 0.6em; }
    .generate-btn { width: 100%; margin-bottom: 1.5em; }
        #qrContainer { display: flex; flex-direction: column; align-items: center; margin-top: 2em; }
        #qrCode { margin-bottom: 1.2em; }
    #paymentStatus { font-size: 1.05em; color: var(--success-color); margin-bottom: 1.2em; text-align: center; }
    .reset-btn { width: auto; }
        @media (max-width: 600px) {
            .container { padding: 1em 0.5em; }
            h1 { font-size: 1.6em; }
            .subtitle { font-size: 0.95em; }
            .amount-input { font-size: 1.3em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Quick Sales / Venta Rápida</h1>
        <div class="subtitle">Generate QR Payments quickly - Powered by Distriator</div>
        <label for="hiveAccountInput">Receiving Hive Account</label>
        <div class="row">
            <input type="text" id="hiveAccountInput" class="form-control" placeholder="e.g. myshop.hive" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" style="text-transform: lowercase;" />
            <button class="btn btn-primary" id="updateAccountBtn">Update</button>
        </div>
        <div class="current-account" id="currentAccountDisplay">
            <span id="currentAccountAvatar" style="vertical-align:middle;display:inline-block;width:32px;height:32px;border-radius:50%;background: var(--border-color);overflow:hidden;margin-right:0.5em;"></span>
            Current: <span id="currentAccount">none</span>
        </div>
        <label for="amountInput">Amount (HBD)</label>
    <input type="number" id="amountInput" class="amount-input form-control" min="0.01" step="0.01" placeholder="0.00" />
    <button class="btn btn-success generate-btn" id="generateQrBtn">Generate QR</button>
        <div id="qrContainer" style="display:none;">
            <div id="qrCode"></div>
            <div id="qrDetails"></div>
            <div id="paymentStatus"></div>
            <button class="btn btn-secondary reset-btn" id="resetBtn" style="display:none;">New Sale</button>
        </div>

        <!-- Recent Incoming Payments -->
        <div class="card" id="recentPaymentsCard" style="margin-top: 2rem;">
            <div class="card-header">
                <h2>Recent Incoming Payments</h2>
            </div>
            <div class="card-body">
                <div id="recentStatus" class="text-muted" style="margin-bottom: 0.75rem;">Set a receiving account to view recent payments.</div>
                <ul id="recentList" style="list-style: none; padding: 0; margin: 0;"></ul>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
    // --- Memo generator (reuse from pos.html) ---
    function generateKcsHposMemo() {
        function randGroup() {
            return Math.random().toString(36).substring(2, 6);
        }
        return `kcs-hpos-${randGroup()}-${randGroup()}`;
    }
    // --- LocalStorage helpers ---
    function getStoredAccount() {
        return localStorage.getItem('quick_hive_account') || '';
    }
    function setStoredAccount(acc) {
        localStorage.setItem('quick_hive_account', acc);
    }
    // --- UI Elements ---
    const hiveAccountInput = document.getElementById('hiveAccountInput');
    const updateAccountBtn = document.getElementById('updateAccountBtn');
    const currentAccount = document.getElementById('currentAccount');
    const currentAccountAvatar = document.getElementById('currentAccountAvatar');
    const amountInput = document.getElementById('amountInput');
    const generateQrBtn = document.getElementById('generateQrBtn');
    const qrContainer = document.getElementById('qrContainer');
    const qrCodeDiv = document.getElementById('qrCode');
    const qrDetails = document.getElementById('qrDetails');
    const paymentStatus = document.getElementById('paymentStatus');
    const resetBtn = document.getElementById('resetBtn');
    // --- Render current account ---
    function renderCurrentAccount() {
        const acc = getStoredAccount();
        currentAccount.textContent = acc ? acc : 'none';
        if (acc) {
            const imgUrl = `https://images.hive.blog/u/${acc.toLowerCase()}/avatar`;
            currentAccountAvatar.innerHTML = `<img src="${imgUrl}" alt="avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;vertical-align:middle;" onerror=\"this.onerror=null;this.src='https://images.hive.blog/u/ecency/avatar';\">`;
        } else {
            currentAccountAvatar.innerHTML = '';
        }
    }
    renderCurrentAccount();
    // Force lowercase (and strip leading @) as the user types
    hiveAccountInput.addEventListener('input', () => {
        const pos = hiveAccountInput.selectionStart;
        const val = hiveAccountInput.value;
        const sanitized = val.toLowerCase().replace(/^@+/, '');
        if (val !== sanitized) {
            hiveAccountInput.value = sanitized;
            if (typeof pos === 'number') {
                const newPos = Math.max(0, pos - (val.length - sanitized.length));
                hiveAccountInput.setSelectionRange(newPos, newPos);
            }
        }
    });
    // --- Update account logic ---
    updateAccountBtn.onclick = function() {
        const acc = hiveAccountInput.value.trim().toLowerCase().replace(/^@+/, '');
        if (!acc) { alert('Please enter a Hive account.'); return; }
        setStoredAccount(acc);
        renderCurrentAccount();
    updateRecentTransactions();
        hiveAccountInput.value = '';
    };
    // --- Generate QR logic ---
    generateQrBtn.onclick = function() {
        const acc = getStoredAccount();
        const amt = parseFloat(amountInput.value);
        if (!acc) { alert('No receiving account set.'); return; }
        if (!amt || amt < 0.01) { alert('Enter a valid amount.'); return; }
        // Memo
        const memo = generateKcsHposMemo();
        window.lastPaymentMemo = memo;
        window.lastPaymentAmount = amt.toFixed(3) + ' HBD';
        // Hive op
        const op = [
            "transfer",
            {
                to: acc,
                amount: amt.toFixed(3) + ' HBD',
                memo: memo
            }
        ];
        const json = JSON.stringify(op);
        const base64 = btoa(json).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
        const uri = `hive://sign/op/${base64}`;
        // Show QR
        qrContainer.style.display = 'flex';
        qrCodeDiv.innerHTML = '';
        new QRCode(qrCodeDiv, {
            text: uri,
            width: 240,
            height: 240,
            colorDark: '#000',
            colorLight: '#fff',
            correctLevel: QRCode.CorrectLevel.H
        });
        qrDetails.innerHTML = `<b>To:</b> @${acc}<br><b>Amount:</b> ${amt.toFixed(3)} HBD<br><b>Memo:</b> <span style='font-family:monospace;'>${memo}</span>`;
        paymentStatus.textContent = '⏳ Waiting for payment...';
        resetBtn.style.display = 'none';
        startPaymentListener(acc, amt.toFixed(3) + ' HBD', memo);
    };
    // --- Payment Listener (reuse logic from pos.html) ---
    let paymentListenerInterval = null;
    function startPaymentListener(hiveAccount, expectedAmount, expectedMemo) {
        if (paymentListenerInterval) clearInterval(paymentListenerInterval);
        let attempts = 0;
        paymentListenerInterval = setInterval(async function() {
            attempts++;
            try {
                const response = await fetch('https://api.hive.blog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'condenser_api.get_account_history',
                        params: [hiveAccount, -1, 20],
                        id: 1
                    })
                });
                const data = await response.json();
                const history = data.result;
                for (let i = history.length - 1; i >= 0; i--) {
                    const op = history[i][1].op;
                    if (op[0] === 'transfer' &&
                        op[1].to === hiveAccount &&
                        op[1].amount === expectedAmount &&
                        op[1].memo === expectedMemo) {
                        paymentStatus.textContent = '✅ Payment received!';
                        clearInterval(paymentListenerInterval);
                        paymentListenerInterval = null;
                        resetBtn.style.display = 'block';
                        // Refresh recent transactions after a confirmed payment
                        updateRecentTransactions();
                        alert('Payment confirmed!');
                        return;
                    }
                }
                paymentStatus.textContent = '⏳ Waiting for payment...';
            } catch (e) {
                paymentStatus.textContent = 'Error checking payment.';
            }
            if (attempts > 100) {
                paymentStatus.textContent = 'Payment not detected. Please check manually.';
                clearInterval(paymentListenerInterval);
                paymentListenerInterval = null;
                resetBtn.style.display = 'block';
            }
        }, 3000);
    }
    // --- Reset logic ---
    resetBtn.onclick = function() {
        qrContainer.style.display = 'none';
        qrCodeDiv.innerHTML = '';
        qrDetails.innerHTML = '';
        paymentStatus.textContent = '';
        amountInput.value = '';
        resetBtn.style.display = 'none';
    };

    // --- Recent Incoming Payments ---
    function formatAmount(amountStr) {
        return amountStr; // already like '1.000 HBD'
    }

    function truncateMemo(memo, max = 60) {
        if (!memo) return '';
        return memo.length > max ? memo.slice(0, max - 1) + '…' : memo;
    }

    async function fetchRecentIncoming(hiveAccount, desired = 10) {
        try {
            const res = await fetch('https://api.hive.blog', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'condenser_api.get_account_history',
                    params: [hiveAccount, -1, 100],
                    id: 2
                })
            });
            const data = await res.json();
            const history = data.result || [];
            const incoming = [];
            for (let i = history.length - 1; i >= 0; i--) {
                const rec = history[i][1];
                const op = rec.op;
                if (op && op[0] === 'transfer') {
                    const details = op[1];
                    if (details && details.to && details.to.toLowerCase() === hiveAccount.toLowerCase()) {
                        incoming.push({
                            from: details.from,
                            to: details.to,
                            amount: details.amount,
                            memo: details.memo,
                            timestamp: rec.timestamp
                        });
                        if (incoming.length >= desired) break;
                    }
                }
            }
            return incoming;
        } catch (e) {
            console.error('Failed to fetch recent incoming payments:', e);
            return null;
        }
    }

    function renderRecentTransactions(list) {
        const status = document.getElementById('recentStatus');
        const ul = document.getElementById('recentList');
        if (!list) {
            status.textContent = 'Failed to load recent payments.';
            ul.innerHTML = '';
            return;
        }
        if (list.length === 0) {
            status.textContent = 'No recent incoming payments found.';
            ul.innerHTML = '';
            return;
        }
        status.textContent = '';
        ul.innerHTML = list.map(tx => {
            const when = new Date(tx.timestamp + 'Z');
            const timeStr = isNaN(when.getTime()) ? tx.timestamp : when.toLocaleString();
            const memo = tx.memo ? ` • <span class="text-muted">${truncateMemo(tx.memo)}</span>` : '';
            return `
                <li style="padding: 0.6rem 0; border-bottom: 1px solid var(--border-color);">
                    <div style="display:flex; justify-content: space-between; gap: 0.75rem;">
                        <div>
                            <strong>${formatAmount(tx.amount)}</strong> from @${tx.from}${memo}
                        </div>
                        <div class="text-muted" style="white-space: nowrap;">${timeStr}</div>
                    </div>
                </li>
            `;
        }).join('');
    }

    async function updateRecentTransactions() {
        const acc = getStoredAccount();
        const status = document.getElementById('recentStatus');
        const ul = document.getElementById('recentList');
        if (!acc) {
            status.textContent = 'Set a receiving account to view recent payments.';
            ul.innerHTML = '';
            return;
        }
        status.textContent = 'Loading recent payments…';
        ul.innerHTML = '';
        const list = await fetchRecentIncoming(acc, 10);
        renderRecentTransactions(list);
    }

    // Initial load
    updateRecentTransactions();
    </script>
</body>
</html>
